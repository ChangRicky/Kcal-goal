<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>減脂熱量跟目標設定</title>
  <!--
    BeBetter Lite 減脂計算器
    本頁提供簡單的減脂試算，幫助你用科學的數字了解自己。
    這是一個純前端的範例，無需連網也可使用。為了適應手機、平板與桌面，採用彈性布局。
    色彩來自品牌：深墨綠搭配嫩綠與金色作點綴。
  -->
  <style>
    :root {
      /*
        使用品牌橘色系作為主題色，提升視覺一致性與高級感。
        safe 範圍設定為減脂 300~700 kcal、增肌 -300~0 kcal；負值代表盈餘。
      */
      /*
        改用柔和的暖橘與米白色調，配合品牌精神帶出高級感。
        使用 60-30-10 原則：背景佔 60%，主色 30%，強調色 10%。
        引用 NN/g 指南指出，精選的調色盤和一致的排版能提高美感【715461275291268†L51-L53】。
      */
      --primary-color: #c45b48; /* 深珊瑚橘，作為標題與按鈕顏色 */
      --accent-color: #e17c45; /* 柔和桃橘，用於次要按鈕與數字顯示 */
      --highlight-color: #f8c794; /* 淡金桃色，點綴元素 */
      --background-color: #fffaf5; /* 暖米白背景，增添溫暖感 */
      --text-color: #4a2e2b; /* 深棕作為主文字色，提升可讀性 */
      /* 安全範圍設定：維持之前 300–700 及 -300–0 區間不變 */
      --safe-min-fat: 300;
      --safe-max-fat: 700;
      --safe-min-gain: -300;
      /* 新的增肌推薦區間為 +100~+300 kcal（換算為差值 -300~-100） */
      --safe-max-gain: -100;
      /* 低飽和度安全色：使用品牌色淡化版本，避免過於突兀 */
      --safe-color-fat: rgba(243, 137, 103, 0.18); /* 淺橘 */
      --safe-color-gain: rgba(130, 192, 162, 0.18); /* 淺綠 */
      /* 表格斑馬紋顏色：淡米白 */
      --table-row-alt: #fdf4f0;
      /* 表頭底色：淡杏色 */
      --table-header-bg: #fde4d1;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "Inter", "Noto Sans TC", sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.5;
    }
    h1, h2, h3 {
      margin: 0;
      font-weight: 600;
      color: var(--primary-color);
    }
    h1 {
      font-size: 1.6rem;
    }
    h2 {
      font-size: 1.4rem;
      margin-top: 1rem;
      margin-bottom: 0.75rem;
      text-align: center;
    }
    h3 {
      font-size: 1.2rem;
      margin-bottom: .25rem;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    header img {
      height: 48px;
      width: auto;
    }
    header h1 {
      flex: 1;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
      /* 卡片樣式：白色背景、圓角與陰影讓每一步更加聚焦 */
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      margin-top: 1.5rem;
      width: 100%;
      max-width: 600px;
    }
    .steps-nav {
      display: flex;
      justify-content: space-between;
      /* 再拉大上下間距與按鈕間距，提供更多空間感 */
      margin: 2rem 0 3rem 0;
      gap: 1.5rem;
    }
    .steps-nav button {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .steps-nav button:hover {
      background-color: var(--accent-color);
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      align-items: center;
    }
    label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      /* 使標籤區域保持固定寬度以便居中 */
      width: 100%;
      max-width: 360px;
      text-align: left;
    }
    input[type="number"], select {
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 0.25rem;
      /* 控制欄位寬度，根據父元素寬度自適應，並限制最大寬度 */
      width: 100%;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }

    /* 調整滑桿的寬度填滿容器，避免受到上面欄位寬度限制 */
    input[type="range"] {
      width: 100%;
    }
    .radio-group {
      display: flex;
      /* 將性別選項間距調整得更緊密，避免分散感 */
      gap: 0.2rem;
    }
    .radio-group label {
      flex-direction: row;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }
    .activity-cards {
      /* 改為直式排列，提高閱讀性 */
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.2rem;
      margin-top: 1rem;
    }
    .activity-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.7rem;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      width: 100%;
      max-width: 360px;
    }
    .activity-card.active {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: #fff;
    }
    .bodyfat-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .bodyfat-images {
      /* 垂直排列體脂參考圖片，避免並排太小 */
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding-bottom: 1rem;
    }
    .bodyfat-images img {
      /* 讓圖片寬度適應容器，高度自動，以維持比例；使用更大寬度避免過小 */
      width: 90%;
      height: auto;
      border-radius: 8px;
      flex-shrink: 0;
    }
    .slider-container {
      margin-top: 1rem;
    }
    input[type="range"] {
      width: 100%;
    }
    .results {
      margin-top: 1rem;
      background-color: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    /* 全局步驟段落樣式：置中且限制寬度 */
    .step p {
      text-align: center;
      max-width: 600px;
      margin: 0.5rem auto 1rem;
    }
    .results h3 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .stat-grid {
      /* 使用垂直排列的格子，內含多行資訊卡 */
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    /* 自訂上排與下排卡片的寬度，避免擁擠 */
    .stat-row.top-row .stat-card {
      flex: 1 1 calc(33.333% - 0.67rem);
      min-width: 160px;
    }
    /* 第二排統計卡片：允許換行，每列最多 2 張卡片，提供更舒適的空間 */
    .stat-row.bottom-row {
      flex-wrap: wrap;
    }
    .stat-row.bottom-row .stat-card {
      flex: 1 1 calc(50% - 0.75rem);
      min-width: 160px;
    }

    .stat-card {
      flex: 1 1 auto;
      min-width: 140px;
      border: 1px solid var(--table-row-alt);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      background-color: #FFFFFF;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* 突出顯示目標熱量卡片：使用淡色背景與深色邊框 */
    .highlight-card {
      border: 2px solid var(--accent-color);
      background-color: rgba(226, 140, 108, 0.12);
    }

    .stat-card span {
      display: block;
      font-size: 1.3rem;
      color: var(--accent-color);
      font-weight: 600;
      margin-top: 0.25rem;
    }

    /* 強調目標熱量標籤，使其更醒目 */
    #targetLabel {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      overflow: hidden;
      border-radius: 6px;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    th, td {
      padding: 0.5rem;
      text-align: center;
      border: none;
    }
    th {
      background-color: var(--table-header-bg);
      color: var(--primary-color);
    }

    /* 為表格添加淡淡的分隔線，提升質感 */
    #deficitTable tr {
      border-bottom: 1px solid #f2e7e2;
    }
    #deficitTable tr:last-child {
      border-bottom: none;
    }
    .safe {
      background-color: var(--accent-color);
      color: #fff;
    }

    /* 移除斑馬紋，以保持非推薦行無背景色 */
    #deficitTable tr:nth-child(even):not(.safe-fat):not(.safe-gain) {
      background-color: transparent;
    }

    /* 新的安全範圍樣式：低飽和度色彩與動態背景 */
    .safe-fat {
      background: var(--safe-color-fat);
      color: var(--text-color);
      animation: safePulse 6s linear infinite;
      font-weight: 600;
    }
    .safe-gain {
      background: var(--safe-color-gain);
      color: var(--text-color);
      animation: safePulse 6s linear infinite;
      font-weight: 600;
    }

    /* 漸變動效 */
    @keyframes safePulse {
      0% { background-position: 0 0; }
      100% { background-position: 200% 0; }
    }

    /* 滑桿容器與安全區顯示條 */
    .slider-wrapper {
      position: relative;
    }
    #safeBar {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      height: 8px;
      border-radius: 4px;
      z-index: 0;
      left: 0;
      width: 0;
      /* 顏色與動畫會在 JS 中設定 */
      pointer-events: none;
    }
    #deficitRange {
      position: relative;
      z-index: 1;
    }

    /* 每日差值標籤與數值：水平排列並加上動態效果 */
    .deficit-label {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 0.4rem;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    #deficitValue {
      font-weight: 700;
      transition: color 0.2s, transform 0.2s;
    }
    /* 動態動畫：拉桿移動時數值放大後回彈 */
    @keyframes valuePulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    /* 安全範圍文字 */
    .safe-range-text {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--primary-color);
      display: inline-block;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      background-color: rgba(235,124,94,0.1);
    }

    /* CTA 按鈕自定義外觀 */
    .cta-btn {
      background: linear-gradient(45deg, var(--accent-color), var(--highlight-color));
      border: none;
      color: #fff;
      padding: 0.7rem 1.4rem;
      border-radius: 20px;
      text-decoration: none;
      display: inline-block;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .cta-btn:hover {
      transform: scale(1.05);
    }
    .download-btn, .cta-btn {
      display: inline-block;
      margin-top: 1rem;
      padding: 0.6rem 1.4rem;
      border-radius: 8px;
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    /* 下載按鈕使用主色，滑過時使用亮綠色 */
    .download-btn {
      background-color: var(--primary-color);
      color: #ffffff;
    }
    .download-btn:hover {
      background-color: var(--accent-color);
    }
    /* CTA 按鈕使用亮綠色，滑過時變為珊瑚色 */
    .cta-btn {
      background-color: var(--accent-color);
      color: #ffffff;
    }
    .cta-btn:hover {
      background-color: var(--highlight-color);
    }

    /* Step5 行動區塊：並排或換行排列兩個按鈕 */
    .result-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }

    /* Step5 下載與諮詢區塊樣式 */
    .download-section, .consult-section {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 1.5rem;
      margin: 1rem 0;
      text-align: center;
    }
    .download-section h3, .consult-section h3 {
      color: var(--primary-color);
      font-size: 1.3rem;
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .download-section p, .consult-section p {
      color: var(--text-color);
      font-size: 0.9rem;
      margin-bottom: 1rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    @media (min-width: 768px) {
      h1 {
        font-size: 2rem;
      }
      h2 {
        font-size: 1.6rem;
      }
    }

    /* 滑鼠跟隨的圓圈 */
    .cursor-circle {
      position: fixed;
      top: 0;
      left: 0;
      /* 將滑鼠特效改為空心圓環包覆在指針外緣，不遮擋內容 */
      width: 60px;
      height: 60px;
      border-radius: 50%;
      pointer-events: none;
      border: 2px solid var(--accent-color);
      /* 無背景填色，只留下圓環，並加上柔和陰影 */
      background: transparent;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.08s linear;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- 滑鼠跟隨圓圈：提升互動感 -->
  <div class="cursor-circle" id="cursorCircle"></div>
  <div class="container">
    <header>
      <!-- logo 已移除，如需放置品牌圖可在此處加入 <img> -->
      <h1>減脂熱量跟目標設定</h1>
    </header>

    <!-- Step navigation (progress indicator hidden initially) -->
    <div class="steps-nav">
      <button id="prevBtn" onclick="prevStep()" disabled>上一步</button>
      <button id="nextBtn" onclick="nextStep()">下一步</button>
    </div>

    <!-- Step 1: 基本資料 -->
    <section id="step1" class="step active">
      <h2>基本資料</h2>
      <form id="form1">
        <label>性別
          <div class="radio-group">
            <label><input type="radio" name="sex" value="male" checked> 男</label>
            <label><input type="radio" name="sex" value="female"> 女</label>
          </div>
        </label>
        <label>年齡 (歲)
          <input type="number" name="age" min="15" max="75" value="25" required>
        </label>
        <label>身高 (cm)
          <input type="number" name="height" min="130" max="210" value="170" required>
        </label>
        <label>體重 (kg)
          <input type="number" name="weight" min="35" max="200" value="65" required>
        </label>
      </form>
    </section>

    <!-- Step 2: 活動量 -->
    <section id="step2" class="step">
      <h2>活動量</h2>
      <p>請選擇你過去兩週最常見的活動量</p>
      <div class="activity-cards" id="activityCards">
        <div class="activity-card" data-value="1.2">
          <h3>久坐</h3>
          <p>幾乎不運動</p>
        </div>
        <div class="activity-card" data-value="1.375">
          <h3>輕量</h3>
          <p>每週 1–3 次運動</p>
        </div>
        <div class="activity-card" data-value="1.55">
          <h3>中等</h3>
          <p>每週 3–5 次運動</p>
        </div>
        <div class="activity-card" data-value="1.725">
          <h3>高量</h3>
          <p>每週 6–7 次運動</p>
        </div>
        <div class="activity-card" data-value="1.9">
          <h3>運動員</h3>
          <p>體力勞動或訓練者</p>
        </div>
      </div>
    </section>

    <!-- Step 3: 體型與目標 -->
    <section id="step3" class="step">
      <h2>體型與目標</h2>
      <p>選擇你的體型（體脂等級）與目標方向</p>
      <div class="bodyfat-container">
        <!-- 提供男性與女性體脂參考圖片。請將檔案 male_bodyfat.png 與 female_bodyfat.png 放入與此 HTML 同層的 images 目錄中。 -->
        <div class="bodyfat-images">
          <img src="images/male_bodyfat.png" alt="男性體脂參考">
          <img src="images/female_bodyfat.png" alt="女性體脂參考">
        </div>
        <label>現在體態（上圖參考）
          <select id="bodyFatSelect">
            <!-- 五級體型分類，並附男女體脂區間說明 -->
            <option value="athlete">運動員 (男性6–13%, 女性14–20%)</option>
            <option value="lean">精實 (男性14–17%, 女性21–24%)</option>
            <option value="standard" selected>標準 (男性18–24%, 女性25–31%)</option>
            <option value="over">過高 (男性25–29%, 女性32–37%)</option>
            <option value="obese">肥胖 (男性≥30%, 女性≥38%)</option>
          </select>
        </label>
        <label>目標方向
          <div class="radio-group">
            <label><input type="radio" name="goal" value="fat_loss" checked> 減脂</label>
            <label><input type="radio" name="goal" value="maintain"> 維持</label>
            <label><input type="radio" name="goal" value="gain"> 增肌</label>
          </div>
        </label>
        <label>目標體重 (kg)
          <input type="number" id="targetWeight" min="30" max="200" value="60" required>
        </label>
      </div>
    </section>

    <!-- Step 4: 熱量赤字與結果 -->
    <section id="step4" class="step">
      <h2>熱量赤字 / 盈餘設定</h2>
      <p>拖曳滑桿調整每日熱量差值，負值代表盈餘（增肌），正值代表赤字（減脂）。建議減脂安全區間：300–700 kcal；增肌安全區間：0–300 kcal。</p>
      <div class="slider-container">
        <div class="slider-wrapper">
          <div id="safeBar"></div>
          <!-- 將標籤與數值包成一行，方便動態更新顏色與動畫 -->
          <div class="deficit-label">
            <span>每日熱量差值 (kcal)：</span>
            <span id="deficitValue">150</span>
          </div>
          <input type="range" id="deficitRange" min="-500" max="1000" step="50" value="150">
        </div>
        <p id="safeRangeText" class="safe-range-text"></p>
      </div>
      <div class="results" id="results">
        <h3>計算結果</h3>
        <div class="stat-grid">
          <!-- 第一行：BMR、建議熱量（凸顯）、TDEE -->
          <div class="stat-row top-row">
            <div class="stat-card">
              BMR<br><span id="bmr">--</span> kcal/日
            </div>
            <div class="stat-card highlight-card" id="targetCard">
              <span id="targetLabel">減脂熱量</span><br><span id="targetKcal">--</span> kcal/日
            </div>
            <div class="stat-card">
              TDEE<br><span id="tdee">--</span> kcal/日
            </div>
          </div>
          <!-- 第二行：分別顯示每週變化、每月變化、達成週數、達成月數，避免資訊擁擠 -->
          <div class="stat-row bottom-row">
            <div class="stat-card">
              每週變化<br><span id="weeklyLoss">--</span> kg
            </div>
            <div class="stat-card">
              每月變化<br><span id="monthlyLoss">--</span> kg
            </div>
            <div class="stat-card">
              達成週數<br><span id="weeks">--</span> 週
            </div>
            <div class="stat-card">
              達成月數<br><span id="months">--</span> 月
            </div>
          </div>
        </div>
        <h3>赤字 / 盈餘對照表</h3>
        <table>
          <thead>
            <tr>
              <th>每日差值 (kcal)</th>
              <th>每週變化 (kg)</th>
              <th>每月變化 (kg)</th>
            </tr>
          </thead>
          <tbody id="deficitTable">
            <!-- rows inserted by JS -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Step 5: 結果與下一步 -->
    <section id="step5" class="step">
      <h2>成果與下一步</h2>
      <!-- 強調下載結果卡：放置於最上方，鼓勵分享與紀錄 -->
      <div class="download-section">
        <h3>下載結果卡</h3>
        <p>立即下載你的專屬結果卡，記錄 BMR、TDEE、建議熱量及預估變化，並分享到社群與好友，鼓勵自己持續前進！</p>
        <a href="#" id="downloadCardBtn" class="download-btn">下載結果卡</a>
      </div>
      <!-- 一對一營養諮詢：放置於第二區塊，提供專業協助 -->
      <div class="consult-section">
        <h3>一對一營養諮詢</h3>
        <p>想加速目標達成？立即預約一對一營養諮詢，由專業營養師為你量身規劃餐食與運動，陪伴你健康前行。</p>
        <a href="#" id="consultBtn" class="cta-btn">預約一對一諮詢</a>
      </div>
    </section>
  </div>

  <script>
    // 全局狀態
    let currentStep = 1;
    let selectedActivity = null;

    // 體脂參考按鈕添加事件
    document.querySelectorAll('.activity-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.activity-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        selectedActivity = parseFloat(card.dataset.value);
      });
    });

    // 啟動 slider 事件
    const deficitRange = document.getElementById('deficitRange');
    const deficitValueEl = document.getElementById('deficitValue');
    deficitRange.addEventListener('input', () => {
      // 更新顯示值
      const rawVal = parseFloat(deficitRange.value);
      // 格式化顯示：正值顯示為 -X（赤字），負值顯示為 +X（盈餘）
      let displayVal = '';
      if (rawVal > 0) {
        displayVal = '-' + rawVal;
      } else if (rawVal < 0) {
        displayVal = '+' + Math.abs(rawVal);
      } else {
        displayVal = '0';
      }
      deficitValueEl.textContent = displayVal;
      // 根據正負設定顏色：赤字為珊瑚色，盈餘為綠色
      if (rawVal >= 0) {
        deficitValueEl.style.color = 'var(--accent-color)';
      } else {
        deficitValueEl.style.color = '#5a8f78';
      }
      // 加入動畫效果：每次值變更時縮放回彈
      deficitValueEl.style.animation = 'valuePulse 0.4s ease';
      setTimeout(() => {
        deficitValueEl.style.animation = '';
      }, 400);
      if(currentStep >= 4) computeResults();
    });

    // 下一步與上一步
    function showStep() {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + currentStep).classList.add('active');
      // 控制按鈕
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      prevBtn.disabled = currentStep === 1;
      if (currentStep === 4) {
        nextBtn.textContent = '完成';
        // When displaying step 4, recompute results so all values reflect the current slider and inputs
        computeResults();
      } else if (currentStep === 5) {
        nextBtn.style.display = 'none';
        prevBtn.style.display = 'none';
        // 在顯示結果頁時產生結果卡
        generateResultCard();
      } else {
        nextBtn.textContent = '下一步';
        nextBtn.style.display = '';
        prevBtn.style.display = '';
      }
    }
    function nextStep() {
      if (currentStep === 1) {
        // 檢查資料
        const form = document.getElementById('form1');
        if(!form.checkValidity()) {
          form.reportValidity();
          return;
        }
      }
      if (currentStep === 2 && !selectedActivity) {
        alert('請選擇活動量。');
        return;
      }
      if (currentStep === 3) {
        // 設定預設赤字顯示
        computeResults();
      }
      currentStep++;
      if (currentStep > 5) currentStep = 5;
      showStep();
    }
    function prevStep() {
      currentStep--;
      if (currentStep < 1) currentStep = 1;
      showStep();
    }
    showStep();

    // 全局存儲計算結果，用於產生結果卡
    let computedResults = {};

    // 計算結果函式
    function computeResults() {
      const sex = document.querySelector('input[name="sex"]:checked').value;
      const age = parseFloat(document.querySelector('input[name="age"]').value);
      const height = parseFloat(document.querySelector('input[name="height"]').value);
      const weight = parseFloat(document.querySelector('input[name="weight"]').value);
      const goalType = document.querySelector('input[name="goal"]:checked').value;
      const targetWeight = parseFloat(document.getElementById('targetWeight').value);
      // 基礎代謝
      let bmr;
      if (sex === 'male') {
        bmr = 10 * weight + 6.25 * height - 5 * age + 5;
      } else {
        bmr = 10 * weight + 6.25 * height - 5 * age - 161;
      }
      // 活動量
      const activity = selectedActivity || 1.2;
      const tdee = bmr * activity;
      // 熱量差值 (正值為赤字，負值為盈餘)
      const diffVal = parseFloat(deficitRange.value);
      let usedDeficit = 0;
      let usedSurplus = 0;
      if (goalType === 'fat_loss') {
        usedDeficit = Math.max(0, diffVal);
      } else if (goalType === 'gain') {
        usedSurplus = Math.max(0, -diffVal);
      }
      // 目標熱量
      let targetKcal = tdee - usedDeficit + usedSurplus;
      // 減脂護欄：避免熱量過低
      const minKcal = (sex === 'male') ? Math.max(1500, bmr * 1.1) : Math.max(1200, bmr * 1.1);
      if (goalType === 'fat_loss' && targetKcal < minKcal) {
        targetKcal = minKcal;
      }
      // 每週與每月變化
      const weeklyChangeVal = ((usedDeficit + usedSurplus) * 7) / 7700;
      const monthlyChangeVal = weeklyChangeVal * 4;
      // 週期（週）與月數
      let weeks = '--';
      let monthsToReach = '--';
      if (goalType === 'fat_loss' && weeklyChangeVal > 0) {
        const gap = weight - targetWeight;
        if (gap > 0) {
          weeks = (gap / weeklyChangeVal).toFixed(1);
          monthsToReach = (weeks / 4).toFixed(1);
        } else {
          weeks = 0;
          monthsToReach = 0;
        }
      } else if (goalType === 'gain' && weeklyChangeVal > 0) {
        const gap = targetWeight - weight;
        if (gap > 0) {
          weeks = (gap / weeklyChangeVal).toFixed(1);
          monthsToReach = (weeks / 4).toFixed(1);
        } else {
          weeks = 0;
          monthsToReach = 0;
        }
      } else if (goalType === 'maintain') {
        weeks = 0;
        monthsToReach = 0;
      }
      // 更新介面
      document.getElementById('bmr').textContent = Math.round(bmr);
      document.getElementById('tdee').textContent = Math.round(tdee);
      document.getElementById('targetKcal').textContent = Math.round(targetKcal);
      // 週變化顯示帶符號：赤字 (diff >= 0) 為負，盈餘 (diff < 0) 為正
      const sign = diffVal >= 0 ? '-' : '+';
      const weeklyDisplay = Math.abs(weeklyChangeVal).toFixed(2);
      const monthlyDisplay = Math.abs(monthlyChangeVal).toFixed(2);
      document.getElementById('weeklyLoss').textContent = sign + weeklyDisplay;
      document.getElementById('monthlyLoss').textContent = sign + monthlyDisplay;
      document.getElementById('weeks').textContent = weeks;
      document.getElementById('months').textContent = monthsToReach;
      // 更新赤字/盈餘對照表
      populateDeficitTable();
      // 更新安全範圍條及文字
      updateSafeBar(goalType);
      // 根據目標類型更新標籤文字
      const targetLabelEl = document.getElementById('targetLabel');
      if (goalType === 'gain') {
        targetLabelEl.textContent = '增肌熱量';
      } else if (goalType === 'maintain') {
        targetLabelEl.textContent = '維持熱量';
      } else {
        targetLabelEl.textContent = '減脂熱量';
      }
      // 儲存結果於全局對象
      computedResults = {
        bmr,
        tdee,
        targetKcal,
        diffVal,
        usedDeficit,
        usedSurplus,
        weeklyChangeVal,
        monthlyChangeVal,
        weeks,
        monthsToReach,
        goalType,
        weight,
        targetWeight
      };
    }

    // 建立赤字表格
    function populateDeficitTable() {
      const tbody = document.getElementById('deficitTable');
      tbody.innerHTML = '';
      const deficits = [100,200,300,400,500,600,700,800,900,1000];
      deficits.forEach(d => {
        const weekly = (d * 7 / 7700).toFixed(2);
        const monthly = (weekly * 4).toFixed(1);
        const tr = document.createElement('tr');
        if (d >= 500 && d <= 700) {
          tr.classList.add('safe');
        }
        tr.innerHTML = `\n+          <td>${d}</td>\n+          <td>${weekly}</td>\n+          <td>${monthly}</td>`;
        tbody.appendChild(tr);
      });
    }

    // 生成試跑表 CSV
    function updateTrialPlan() {
      const sex = document.querySelector('input[name="sex"]:checked').value;
      const age = parseFloat(document.querySelector('input[name="age"]').value);
      const height = parseFloat(document.querySelector('input[name="height"]').value);
      const weight = parseFloat(document.querySelector('input[name="weight"]').value);
      const goalType = document.querySelector('input[name="goal"]:checked').value;
      const deficit = parseFloat(deficitRange.value);
      // 重新計算 BMR & TDEE & 建議熱量
      let bmr;
      if (sex === 'male') {
        bmr = 10 * weight + 6.25 * height - 5 * age + 5;
      } else {
        bmr = 10 * weight + 6.25 * height - 5 * age - 161;
      }
      const activity = selectedActivity || 1.2;
      const tdee = bmr * activity;
      let targetKcal;
      if (goalType === 'fat_loss') {
        targetKcal = tdee - deficit;
      } else if (goalType === 'maintain') {
        targetKcal = tdee;
      } else {
        targetKcal = tdee + 300;
      }
      const csvRows = [];
      csvRows.push('日期,預計攝取熱量 (kcal),實際攝取 (kcal),差距 (kcal)');
      for (let i = 1; i <= 30; i++) {
        const date = `Day ${i}`;
        csvRows.push(`${date},${Math.round(targetKcal)},,`);
      }
      const csvContent = csvRows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const downloadLink = document.getElementById('downloadLink');
      downloadLink.href = url;
      downloadLink.download = 'trial_plan.csv';
    }

    // 初始化赤字表格
    populateDeficitTable();

    /*
      重寫 populateDeficitTable 以支援赤字與盈餘兩種安全區域標示。
      此函式將產生 -500 至 1000 的對照表，並以安全色標示減脂 (300~700) 與增肌 (-300~0)。
    */
    populateDeficitTable = function() {
      const tbody = document.getElementById('deficitTable');
      tbody.innerHTML = '';
      const values = [];
      // 全範圍顯示：從 -500 到 1000，每 100 為一格，跳過 0
      for (let v = -500; v <= 1000; v += 100) {
        if (v === 0) continue;
        values.push(v);
      }
      values.forEach(val => {
        const weekly = ((Math.abs(val) * 7) / 7700).toFixed(2);
        const monthly = (weekly * 4).toFixed(2);
        const tr = document.createElement('tr');
        // 高亮減脂安全區間：正值 300~700；高亮增肌安全區間：負值 -100~-300
        if (val > 0 && val >= 300 && val <= 700) {
          tr.classList.add('safe-fat');
        }
        if (val < 0 && val <= -100 && val >= -300) {
          tr.classList.add('safe-gain');
        }
        const sign = val > 0 ? '-' : '+';
        const displayVal = val > 0 ? `-${val}` : `+${Math.abs(val)}`;
        tr.innerHTML = `
          <td>${displayVal}</td>
          <td>${sign}${weekly}</td>
          <td>${sign}${monthly}</td>`;
        tbody.appendChild(tr);
      });
    };

    /*
      更新滑桿背後的安全區顯示條以及推薦文字。
      根據目標類型 (減脂或增肌) 設定不同的安全區段與顏色。
    */
    function updateSafeBar(goalType) {
      const rangeEl = document.getElementById('deficitRange');
      const safeBar = document.getElementById('safeBar');
      const safeText = document.getElementById('safeRangeText');
      const min = parseFloat(rangeEl.min);
      const max = parseFloat(rangeEl.max);
      let safeMin, safeMax, colorVar, text;
      if (goalType === 'gain') {
        safeMin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-min-gain'));
        safeMax = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-max-gain'));
        colorVar = getComputedStyle(document.documentElement).getPropertyValue('--safe-color-gain');
        // 使用星號符號突出推薦範圍，增肌推薦100–300 kcal
        text = '⭐️ 推薦增肌熱量範圍：100–300 kcal (盈餘)';
      } else {
        safeMin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-min-fat'));
        safeMax = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-max-fat'));
        colorVar = getComputedStyle(document.documentElement).getPropertyValue('--safe-color-fat');
        text = '⭐️ 推薦減脂熱量範圍：300–700 kcal (赤字)';
      }
      const total = max - min;
      const left = (safeMin - min) / total * 100;
      const width = (safeMax - safeMin) / total * 100;
      safeBar.style.left = `${left}%`;
      safeBar.style.width = `${width}%`;
      safeBar.style.background = colorVar.trim();
      safeText.textContent = text;
      // 根據目標類型調整背景顏色，提供淡色背景作為推薦提示
      if (goalType === 'gain') {
        safeText.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--safe-color-gain').trim();
      } else {
        safeText.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--safe-color-fat').trim();
      }
    }

    /*
      根據當前計算結果產生結果卡圖片並賦值於下載連結。
      卡片包含基本數據、表格和行動指令。
    */
    function generateResultCard() {
      if (!computedResults || !computedResults.tdee) return;
      const {
        bmr,
        tdee,
        targetKcal,
        diffVal,
        weeklyChangeVal,
        monthlyChangeVal,
        weeks,
        monthsToReach,
        goalType
      } = computedResults;
      // Prepare canvas
      const canvas = document.createElement('canvas');
      const width = 1080;
      const height = 1920;
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      // Brand colour palette: warm orange and beige tones used across the BeBetter product.
      // These colours echo the primary UI theme from the calculator: coral oranges and warm browns.
      const darkBg = '#fffaf5';            // overall light beige background for the card
      const panelColor = '#fff3eb';        // slightly deeper beige for panels
      const borderColor = '#ead8cb';       // light brown for borders and separators
      const textColor = '#4b3e35';         // dark warm brown for general text
      const accentNeutral = '#d0502a';     // primary coral accent for titles and metrics
      const accentNeg = '#d0502a';         // same coral accent for deficit values
      const accentPos = '#dd6726';         // secondary warm orange for surplus values (unused for fat_loss)
      // Goal-based title and accent colour
      let titleText;
      if (goalType === 'gain') {
        titleText = 'BeBetter 增肌結果卡';
      } else if (goalType === 'maintain') {
        titleText = 'BeBetter 維持結果卡';
      } else {
        titleText = 'BeBetter 減脂結果卡';
      }
      // Use golden accent for titles and icons
      const accent = accentNeutral;
      // Fill entire background
      ctx.fillStyle = darkBg;
      ctx.fillRect(0, 0, width, height);
      // Draw page title centered at top
      ctx.fillStyle = accent;
      ctx.font = 'bold 62px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(titleText, width / 2, 90);
      // Compute sign and colours for current settings
      const signForVal = diffVal >= 0 ? '-' : '+';
      const valColor = diffVal >= 0 ? accentNeg : accentPos;
      // Determine goal label
      const goalLabel = goalType === 'gain' ? '增肌熱量' : goalType === 'maintain' ? '維持熱量' : '減脂熱量';
      // Draw top metrics row (3 items): BMR, Target, TDEE
      const topY = 150;
      const topH = 260; // 增加高度提供更大間距
      const topX = 60;
      const topW = width - 120;
      // Panel background
      ctx.fillStyle = panelColor;
      ctx.fillRect(topX, topY, topW, topH);
      const cols1 = 3;
      const cellW1 = topW / cols1;
      const metrics1 = [
        { label: 'BMR', value: Math.round(bmr) + ' kcal', color: accentNeutral },
        { label: goalLabel, value: Math.round(targetKcal) + ' kcal', color: accentNeutral },
        { label: 'TDEE', value: Math.round(tdee) + ' kcal', color: accentNeutral }
      ];
      metrics1.forEach((item, i) => {
        const cx = topX + i * cellW1;
        // optional vertical divider
        if (i > 0) {
          ctx.strokeStyle = borderColor;
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(cx, topY + 20);
          ctx.lineTo(cx, topY + topH - 20);
          ctx.stroke();
        }
        // draw label
        ctx.fillStyle = textColor;
        ctx.font = '26px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(item.label, cx + cellW1 / 2, topY + 65);
        // draw value with accent colour. 使用較小字體並置中，避免相鄰卡片文字擁擠
        ctx.fillStyle = item.color;
        ctx.font = 'bold 60px sans-serif';
        ctx.fillText(item.value, cx + cellW1 / 2, topY + 160);
      });
      // Draw second metrics rows (4 items in 2x2 grid)
      const secondY = topY + topH + 40;
      const rowH = 220;
      const colW2 = (topW / 2);
      const metrics2 = [
        { label: '每週變化', value: signForVal + Math.abs(weeklyChangeVal).toFixed(2) + ' kg', color: accentNeutral },
        { label: '每月變化', value: signForVal + Math.abs(monthlyChangeVal).toFixed(2) + ' kg', color: accentNeutral },
        { label: '達成週數', value: (weeks === '--' ? '--' : weeks) + ' 週', color: accentNeutral },
        { label: '達成月數', value: (monthsToReach === '--' ? '--' : monthsToReach) + ' 月', color: accentNeutral }
      ];
      // Panel background for second rows
      ctx.fillStyle = panelColor;
      ctx.fillRect(topX, secondY, topW, rowH * 2);
      metrics2.forEach((item, idx) => {
        const row = Math.floor(idx / 2);
        const col = idx % 2;
        const cx = topX + col * colW2;
        const cy = secondY + row * rowH;
        // vertical divider lines
        if (col === 1) {
          ctx.strokeStyle = borderColor;
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(cx, cy + 20);
          ctx.lineTo(cx, cy + rowH - 20);
          ctx.stroke();
        }
        // horizontal divider line
        if (row === 1 && col === 0) {
          ctx.strokeStyle = borderColor;
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(topX + 10, cy);
          ctx.lineTo(topX + topW - 10, cy);
          ctx.stroke();
        }
        // draw label
        ctx.fillStyle = textColor;
        ctx.font = '22px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(item.label, cx + colW2 / 2, cy + 60);
        // draw value
        ctx.fillStyle = item.color;
        ctx.font = 'bold 48px sans-serif';
        ctx.fillText(item.value, cx + colW2 / 2, cy + 135);
      });
      // Draw bar chart area
      // Determine starting Y position for chart section: leave breathing space after metrics rows
      const chartYStart = secondY + rowH * 2 + 60;
      // Height for legacy usage (unused in new unified bar chart), kept for compatibility
      const chartH = 420;
      const chartW = topW;
      const chartX = topX;
      // Chart panel background
      ctx.fillStyle = panelColor;
      ctx.fillRect(chartX, chartYStart, chartW, chartH + 130);
      // Chart title
      ctx.fillStyle = accentNeutral;
      ctx.font = 'bold 32px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('推薦差值 vs 每週變化', chartX + chartW / 2, chartYStart + 60);
      // Determine recommended differences for chart
      let recDiffs;
      if (goalType === 'gain') {
        recDiffs = [100, 200, 300];
      } else if (goalType === 'maintain') {
        recDiffs = [0];
      } else {
        recDiffs = [300, 500, 700];
      }
      // Compute weekly change values (kg) for each recommended difference
      const recChanges = recDiffs.map(v => {
        const changeVal = (v * 7) / 7700;
        return goalType === 'gain' ? changeVal : -changeVal;
      });
      // Use absolute values for bar heights to show magnitude of change
      const recAbsChanges = recChanges.map(c => Math.abs(c));
      const maxAbs = Math.max(...recAbsChanges);
      // Chart layout: bars anchored at the bottom of bar area (unified orientation)
      const barAreaHeight = 300;
      const barPanelHeight = barAreaHeight + 140; // include space for labels above and below
      // Draw chart panel background
      ctx.fillStyle = panelColor;
      ctx.fillRect(chartX, chartYStart + 80, chartW, barPanelHeight);
      // Draw bars
      const barCount = recDiffs.length;
      const barSpacing = 80;
      const barWidth = (chartW - 80 - barSpacing * (barCount - 1)) / barCount;
      const barBaseY = chartYStart + 80 + barAreaHeight;
      recDiffs.forEach((diff, i) => {
        const change = recChanges[i];
        const absChange = recAbsChanges[i];
        const barHeight = maxAbs > 0 ? absChange / maxAbs * (barAreaHeight - 60) : 0;
        const bx = chartX + 40 + i * (barWidth + barSpacing);
        // Determine bar colour: use coral for deficits and a lighter orange for surpluses
        let barColor;
        if (change < 0) {
          barColor = accentNeutral;
        } else if (change > 0) {
          // lighter shade for potential surplus bars
          barColor = '#f2b06a';
        } else {
          barColor = accentNeutral;
        }
        ctx.fillStyle = barColor;
        ctx.fillRect(bx, barBaseY - barHeight, barWidth, barHeight);
        // Outline the bar
        ctx.strokeStyle = borderColor;
        ctx.lineWidth = 1;
        ctx.strokeRect(bx, barBaseY - barHeight, barWidth, barHeight);
        // Draw weekly change label above bar with units (kg)
        ctx.fillStyle = accentNeutral;
        ctx.font = 'bold 26px sans-serif';
        ctx.textAlign = 'center';
        const weeklyLabel = (change < 0 ? '-' : change > 0 ? '+' : '') + absChange.toFixed(2) + ' kg';
        ctx.fillText(weeklyLabel, bx + barWidth / 2, barBaseY - barHeight - 12);
        // Draw diff label below bar with units (kcal); note: positive diff values represent deficits
        ctx.font = 'bold 26px sans-serif';
        const diffLabel = diff > 0 ? '-' + diff + ' kcal' : diff < 0 ? '+' + Math.abs(diff) + ' kcal' : '0 kcal';
        ctx.fillText(diffLabel, bx + barWidth / 2, barBaseY + 40);
      });
      // Axis labels: horizontal axis label below chart
      ctx.fillStyle = accentNeutral;
      ctx.font = 'bold 24px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('每日差值 (kcal)', chartX + chartW / 2, chartYStart + 80 + barPanelHeight + 40);
      // Determine the end position of the chart section to place action panel below it
      // chartPanelTop and barPanelHeight were defined earlier when drawing the bar chart
      const chartPanelTop = chartYStart + 80;
      const chartPanelBottom = chartPanelTop + barPanelHeight;
      const axisLabelOffset = 50; // space for axis label and padding
      const actionY = chartPanelBottom + axisLabelOffset;
      const actionH = 550;
      // Draw call-to-action panel
      ctx.fillStyle = panelColor;
      ctx.fillRect(topX, actionY, topW, actionH);
      // Section header: highlight with golden accent
      ctx.fillStyle = accent;
      ctx.font = 'bold 42px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('你的下一步', topX + 20, actionY + 65);
      // List of action items with icons and text
      const actions = [
        { icon: '✅', text: '今天：到 MFP 設定你的' + (goalType === 'gain' ? '增肌熱量' : goalType === 'maintain' ? '維持熱量' : '減脂熱量') + '，按課程 W6 設計三大營養素' },
        { icon: '📊', text: '本週目標：每天空腹量體重、體態照、紀錄飲食' },
        { icon: '🚀', text: '更多內容：可以到 BeBetter 成長學院觀看' },
        { icon: '🔍', text: '如何加入/登入：Skool 搜尋「BeBetter 成長學院」' }
      ];
      // Starting Y position for first action line; leave more space after the section title
      let actionYPos = actionY + 140;
      actions.forEach(item => {
        // Draw icon
        ctx.fillStyle = accent;
        ctx.font = 'bold 36px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(item.icon, topX + 20, actionYPos);
        // Draw text; wrap if necessary at a fixed width
        ctx.fillStyle = textColor;
        ctx.font = '26px sans-serif';
        const startX = topX + 80;
        const maxTextWidth = topW - 100;
        // Function to draw wrapped text
        function drawWrappedText(text, x, y, maxWidth, lineHeight) {
          const words = text.split(/\s+/);
          let line = '';
          let lineY = y;
          words.forEach((word, idx) => {
            const testLine = line + (line ? ' ' : '') + word;
            if (ctx.measureText(testLine).width > maxWidth) {
              ctx.fillText(line, x, lineY);
              line = word;
              lineY += lineHeight;
            } else {
              line = testLine;
            }
          });
          if (line) ctx.fillText(line, x, lineY);
          return lineY + lineHeight;
        }
        // Draw the wrapped text and update Y pos for next item
        actionYPos = drawWrappedText(item.text, startX, actionYPos, maxTextWidth, 36) + 20;
      });
      // Reminder lines at the bottom of the action panel
      ctx.fillStyle = '#888888';
      ctx.font = '24px sans-serif';
      let remind;
      if (goalType === 'gain') {
        remind = '建議每日盈餘 ≤300 kcal，避免脂肪累積';
      } else if (goalType === 'maintain') {
        remind = '維持熱量平衡，避免攝取波動過大';
      } else {
        remind = '建議每日赤字 ≤700 kcal，避免代謝下降';
      }
      const remindersStartY = actionY + actionH - 80;
      ctx.fillText('⚠️ ' + remind, topX + 20, remindersStartY);
      ctx.fillText('📌 體重短期差異來自水分，請以4週為單位觀察', topX + 20, remindersStartY + 40);
      // Convert canvas to image and assign to download link
      const dataURL = canvas.toDataURL('image/png');
      const downloadLink = document.getElementById('downloadCardBtn');
      downloadLink.href = dataURL;
      downloadLink.download = 'result_card.png';
      return dataURL;
    }

    // 點擊下載按鈕產生並下載結果卡
    document.getElementById('downloadCardBtn').addEventListener('click', function(e) {
      e.preventDefault();
      const url = generateResultCard();
      // 生成臨時鏈結以強制觸發下載
      const tmp = document.createElement('a');
      tmp.href = url;
      tmp.download = 'result_card.png';
      document.body.appendChild(tmp);
      tmp.click();
      tmp.remove();
    });

    // 一對一諮詢按鈕：開啟諮詢頁面
    document.getElementById('consultBtn').addEventListener('click', function(e) {
      e.preventDefault();
      window.open('https://243112.typeform.com/to/skpdVy', '_blank');
    });

    // 滑鼠跟隨圓圈效果
    const cursorCircle = document.getElementById('cursorCircle');
    document.addEventListener('mousemove', (e) => {
      // 將圓心放在滑鼠位置，取元素實際尺寸使圓環包覆指針
      const size = cursorCircle.offsetWidth || 50;
      const x = e.clientX - size / 2;
      const y = e.clientY - size / 2;
      cursorCircle.style.transform = `translate(${x}px, ${y}px)`;
    });

  </script>
</body>
</html>